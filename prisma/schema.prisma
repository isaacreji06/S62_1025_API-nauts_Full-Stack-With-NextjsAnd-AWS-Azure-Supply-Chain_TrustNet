generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  phone        String        @unique
  name         String
  password     String?
  email        String?
  role         UserRole      @default(CUSTOMER)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  businesses   Business[]
  endorsements Endorsement[]
  reviews      Review[]

  @@map("users")
}

model Business {
  id                  String              @id @default(cuid())
  name                String
  description         String?
  category            BusinessCategory
  address             String?
  phone               String
  location            String?
  trustScore          Float               @default(0)
  isVerified          Boolean             @default(false)
  verificationMethod  VerificationMethod?
  upiId               String?
  upiVerified         Boolean             @default(false)
  upiVerificationDate DateTime?
  transactionCount    Int                 @default(0)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  ownerId             String
  analytics           BusinessAnalytics?
  owner               User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  endorsements        Endorsement[]
  reviews             Review[]
  upiTransactions     UPI_Transaction[]

  @@index([trustScore])
  @@index([category])
  @@index([isVerified])
  @@map("businesses")
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  businessId String
  reviewerId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  reviewer   User     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  ownerReply String?
  repliedAt  DateTime?
  reviewCount   Int   @default(0)
  averageRating Float @default(0.0)

  @@index([businessId])
  @@index([rating])
  @@map("reviews")
}

model Endorsement {
  id           String          @id @default(cuid())
  relationship EndorsementType
  message      String?
  createdAt    DateTime        @default(now())
  businessId   String
  endorserId   String
  business     Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  endorser     User            @relation(fields: [endorserId], references: [id], onDelete: Cascade)

  @@unique([businessId, endorserId])
  @@index([businessId])
  @@map("endorsements")
}

model BusinessAnalytics {
  id                    String   @id @default(cuid())
  totalReviews          Int      @default(0)
  averageRating         Float    @default(0)
  totalEndorsements     Int      @default(0)
  monthlyVisits         Int      @default(0)
  upiTransactionVolume  Float    @default(0)
  customerRetentionRate Float    @default(0)
  lastUpdated           DateTime @default(now())
  businessId            String   @unique
  business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("business_analytics")
}

model UPI_Transaction {
  id              String   @id @default(cuid())
  upiId           String
  amount          Float
  timestamp       DateTime
  transactionType String?
  customerPattern String?
  businessId      String
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([timestamp])
  @@map("upi_transactions")
}

enum UserRole {
  CUSTOMER
  BUSINESS_OWNER
  ADMIN
}

enum BusinessCategory {
  FOOD_RESTAURANT
  RETAIL_SHOP
  SERVICES
  HOME_BUSINESS
  STREET_VENDOR
  ARTISAN
  OTHER
}

enum VerificationMethod {
  PHONE_OTP
  COMMUNITY_ENDORSEMENT
  UPI_VERIFICATION
  DOCUMENT_VERIFICATION
}

enum EndorsementType {
  CUSTOMER
  NEIGHBOR
  SUPPLIER
  COMMUNITY_MEMBER
}
